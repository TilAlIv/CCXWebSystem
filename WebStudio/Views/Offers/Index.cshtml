@using Microsoft.AspNetCore.Identity
@using X.PagedList.Mvc.Bootstrap4.Core
@using X.PagedList.Mvc.Core
@model X.PagedList.IPagedList<WebStudio.Models.Offer>
@inject UserManager<User> UserManager

@{
    ViewBag.Title = "Коммерческие предложения";
    Layout = "_Layout";
    var count = 1;
    var positionCount = 1;
    var cardNumber = "";
    var codTNVED = "";
}
<div class="mt-5 mb-2 d-flex justify-content-center align-items-baseline">
    <h3>@ViewBag.Title</h3>
    <a asp-controller="Offers" asp-action="Create" asp-route-userId="@UserManager.GetUserId(User)" class="font-italic ml-3">(Добавить новое)</a>
</div>

@using (Html.BeginForm("Index", "Offers", FormMethod.Get, 
    new {@class = "my-3 px-auto py-auto", @style = "border: 1px dotted lightslategrey; border-radius: 8px;"}))
{
    <div class="form-inline form-group">
        <div class="p-4">
            Поиск по лоту: @Html.TextBox("searchByCardNumber", ViewBag.searchByCardNumber as string)
            <input type="submit" class="btn btn-outline-primary py-1 font-13 border-primary" value="Искать"/>
            Поиск по поставщику: @Html.TextBox("searchBySupplierName", ViewBag.searchBySupplierName as string)
            <input type="submit" class="btn btn-outline-primary ml-3 py-1 font-13 border-primary" value="Искать"/>
        </div>
    </div>
}

<div id="body">
    <table class="table" style="width: 100%">
        <thead class="thead-light">
        <tr class="bg-success text-white">
            <th scope="col">№</th>
            <th scope="col" colspan="2">Лот</th>
            <th scope="col" colspan="2">Поставщик</th>
            <th scope="col" colspan="2">Дата КП</th>
            <th scope="col" colspan="2">№ КП</th>
            <th scope="col" colspan="2">Примечание</th>
            <th scope="col" colspan="2">Скачать </th>
            <th scope="col" colspan="2"></th>
        </tr>
        </thead>
        <tbody>
        @if (Model.Count != 0)
        {
            @foreach (var offer in @Model)
            {
                <tr class="bg-light">
                    <th scope="row">@(@count++)</th>
                    <td colspan="2">@(@cardNumber = @offer.CardNumber != null ? @offer.CardNumber : "без номера")</td>
                    <td colspan="2">@offer.SupplierName</td>
                    <td colspan="2">@offer.DateOfIssue.ToShortDateString()</td>
                    <td colspan="2">@offer.Number</td>
                    <td colspan="2">@offer.Note</td>
                    <td colspan="2"><a asp-controller="Offers" asp-action="DownloadFile" asp-route-path="@offer.Path" 
                                       asp-route-fileName="@offer.FileName" class="py-0">КП @offer.SupplierName</a><br>
                        @if (UserManager.FindByIdAsync(@offer.UserId).Result != null)
                        {
                            <small class="font-10 font-italic">добавлено: @UserManager.FindByIdAsync(@offer.UserId).Result.Surname
                                @UserManager.FindByIdAsync(@offer.UserId).Result.Name</small>
                        }
                    </td>
                
                    @if (offer.Card.Positions.Count != 0)
                    {
                        <thead class="font-11 mx-auto">
                        <tr>
                            <th class="py-1">№</th>
                            <th class="py-1">Название</th>
                            <th class="py-1">Ед.изм.</th>
                            <th class="py-1">Кол-ко</th>
                            <th class="py-1">Старт.цена за ед.товара</th>
                            <th class="py-1">Стартовая стоимость</th>
                        </tr>
                        </thead>
                        
                        
                        <tbody class="font-11 pb-1 mx-auto">
                        @foreach (var op in @offer.Card.Positions)
                        {
                            <tr>
                                <th scope="row">@(@positionCount++)</th>
                                <td class="py-1">@op.Name</td>
                                <td class="py-1">@op.Measure</td>
                                <td class="py-1">@op.Amount</td>
                                <td class="py-1">@op.UnitPrice</td>
                                <td class="py-1">@op.TotalPrice</td>
                                <td colspan="2"> <a asp-controller="Calculations" asp-action="AddCalculation" asp-route-positionId="@op.Id" target="_blank">Добавить расчет</a> </td>
                            </tr>
                        }
                        </tbody>
                    }
                </tr>
                    
                <tbody class="border-0">
                <tr class="line"></tr>
                </tbody>
            }
        }
        </tbody>
    </table>
</div>

<p class="text-center">Страница @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) из @Model.PageCount </p>
<div class="row justify-content-center">
    @Html.PagedListPager(Model, page => Url.Action("Index", "Offers", 
        new { page, searchByCardNumber = ViewBag.searchByCardNumber, searchBySupplierName = ViewBag.searchBySupplierName }), Bootstrap4PagedListRenderOptions.Classic)
</div>